preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
exp(-(0.6^2)/2)
exp(0.6)
srr(rep)
exp(rnorm(1, 1, 0.6)
)
exp(rnorm(10, 1, 0.6))
exp(rnorm(10, 1, 0.2))
exp(rnorm(10, 1, 0.02))
exp(rnorm(10, 0, 0.02))
exp(rnorm(10, 0, 0.2))
exp(rnorm(10, 0, 0.6))
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6)
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
Ffa
dimnames(FLQuant())
lf_range(frq)
seq(lf_range(frq)['LFFirst'], by=lf_range(frq)['LWidth'], length=lf_range(frq)['LFIntervals'])
seq(lf_range(frq)['LFFirst'], by=lf_range(frq)['LFWidth'], length=lf_range(frq)['LFIntervals'])
range(frq)
seq(range(frq)[c('minyear','maxyear')])
seq(range(frq)['minyear'],  range(frq)['maxyear'])
1:n_fisheries(frq)
## calculate the catches
simC <- FLQuant(NA, dimnames=list(quant=seq(lf_range(frq)['LFFirst'], by=lf_range(frq)['LFWidth'], length=lf_range(frq)['LFIntervals']),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
range(par)
simC <- FLQuant(NA, dimnames=list(age=seq(1, 16),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
simLC <- FLQuant(NA, dimnames=list(quant=seq(lf_range(frq)['LFFirst'], by=lf_range(frq)['LFWidth'], length=lf_range(frq)['LFIntervals']),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
Ffa[,,1,,]
which(region_fish(frq)==8)
region_fish(frq)
fish_region
region_fish_map <- data.frame(fishey=1:n_fisheries(frq), region=c(region_fish(frq)))
region_fish_map
region_fish_map <- data.frame(fishery=1:n_fisheries(frq), region=c(region_fish(frq)),
name=c('P-ALL-1','S-ALL-1','L-ALL-1','P-ALL-2','S-ALL-2','L-ALL-2','P-ALL-3','S-ALL-3','L-ALL-3','Z-PH-5','Z-ID-5','S-IDPH-5','P-ALL-5','SA-DW-5','SU-DW-5','Z-VN-5','L-ALL-5','P-ALL-6','SA-ALL-6','SU-ALL-6','L-ALL-6','P-ALL-4','L-ALL-4','P-ALL-7','SA-ALL-7','SU-ALL-7','L-ALL-7','P-ALL-8','SA-ALL-8','SU-ALL-8','L-ALL8'))
region_fish_map
## calculate the fishery specific catches
simC <- FLQuant(NA, dimnames=list(age=seq(1, 16),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
for(aa in 2:16){
for(ff in 1:31){
rr <- region_fish_map[region_fish_map$fishery==ff, 'region']
simC[aa,'1972',ff,1,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * popN[aa-1,'1972',,1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
}
}
rr
Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa])
Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * popN[aa-1,'1972',,1,rr]
popN[aa-1,'1972',,1,rr]
popN
simC[aa,'1972',ff,1,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa-1,'1972',,1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
## calculate the fishery specific catches
simC <- FLQuant(NA, dimnames=list(age=seq(1, 16),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
for(aa in 2:16){
for(ff in 1:31){
rr <- region_fish_map[region_fish_map$fishery==ff, 'region']
simC[aa,'1972',ff,1,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa-1,'1972',,1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
}
}
xyplot(data~age|area, group=qname, data=FLQuants(obs=yearMeans(seasonSums(fm(rep)[,as.character(1972:2018)])), sim=Freg),
type="l", auto.key=T)
region_fish_map <- data.frame(fishery=1:n_fisheries(frq), region=c(region_fish(frq)),
name=c('P-ALL-1','S-ALL-1','L-ALL-1','P-ALL-2','S-ALL-2','L-ALL-2','P-ALL-3','S-ALL-3','L-ALL-3','Z-PH-5','Z-ID-5','S-IDPH-5','P-ALL-5','SA-DW-5','SU-DW-5','Z-VN-5','L-ALL-5','P-ALL-6','SA-ALL-6','SU-ALL-6','L-ALL-6','P-ALL-4','L-ALL-4','P-ALL-7','SA-ALL-7','SU-ALL-7','L-ALL-7','P-ALL-8','SA-ALL-8','SU-ALL-8','L-ALL8'))
# Fishery spcecific fishing mortality - F=q.E
# Approximate fishery specific effort values to get similar area based Fs to MFCL
Ef   <- c(rep(4.7,3), rep(11,3), rep(10,3), rep(5.4,2), rep(5,8), rep(8.6,4), rep(10,4), rep(17,4))
qaf  <- seasonMeans(yearMeans(q_fishery(rep)))
Ffa  <- sweep(sel(rep), 3, qaf*Ef, '*')
# Combine fishery specific Fs to area based Fs
Fdf  <- merge(as.data.frame(Ffa), data.frame(unit=1:31, region=c(region_fish(frq))))
Fdf  <- subset(Fdf, !is.element(Fdf$unit, c(3,6,9,17,21,23,27,31))) # drop the longline fisheries from the F calcs
Freg <- FLQuant(c(tapply(Fdf$data, list(Fdf$age, Fdf$region), sum)),
dimnames=list(age=1:16, year='all', unit='unique', season='all', area=1:8, iter=1))
xyplot(data~age|area, group=qname, data=FLQuants(obs=yearMeans(seasonSums(fm(rep)[,as.character(1972:2018)])), sim=Freg),
type="l", auto.key=T)
############################
# Initialisation - first year
# SRR (with bias correction) - set initial SB to some appropriate value and calculate first recruitment
SB1  <- quantSums(seasonMeans(areaSums(sweep(popN(rep)[,'1972'], 1, waa(par)*mat(par), '*'))))
rec1 <- (srr(rep)['a']*SB1)/(srr(rep)['b']+SB1) * exp(-(0.6^2)/2)
# recruitment distribution - regions and seasons
recdist <- yearSums(rec_region(rep)) / sum(rec_region(rep))  # sums to 1
simN <- FLQuant(NA, dimnames=dimnames(popN(rep)))
simN[1,'1972',] <- c(rec1) * recdist
# fill the first season with standard pop decline
for(aa in 2:16)
simN[aa,'1972',,1,] <- simN[aa-1,'1972',,1] * exp(-Freg[aa-1,] -m_at_age(rep)[aa-1])
# plus group
simN[16,'1972',,1,] <- simN[16,'1972',,1,] + simN[16,'1972',,1,] * exp(-Freg[16] -m_at_age(rep)[16])
# fill seasons 2 to 4 with pop decline + movement
for(ssn in 2:4){
for(aa in 2:16){
simN[aa,'1972',,ssn,] <- diff_coffs_age_period(par)[,,aa-1,ssn-1] %*% c(simN[aa-1,'1972',,ssn-1,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,'1972',,ssn,] <- simN[16,'1972',,ssn,] +
c(diff_coffs_age_period(par)[,,16,ssn-1] %*% c(simN[16,'1972',,ssn-1,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
## then loop over years to fill
for(yy in 1973:2018){
SB  <- quantSums(seasonMeans(areaSums(sweep(simN[,as.character(yy-1)], 1, waa(par)*mat(par), '*'))))
#rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(-(0.6^2)/2)
rec <- (srr(rep)['a']*SB)/(srr(rep)['b']+SB) * exp(rnorm(1, 0, 0.6))
simN[1,as.character(yy),] <- c(rec) * recdist
# fill seasons 1 to 4 with pop decline + movement
preyrs  <- c(yy-1, yy, yy, yy)
pressns <- c(4,1,2,3)
for(ssn in 1:4){
preyr  <- preyrs[ssn]
pressn <- pressns[ssn]
for(aa in 2:16){
simN[aa,as.character(yy),,ssn,] <- diff_coffs_age_period(par)[,,aa-1,pressn] %*% c(simN[aa-1,as.character(preyr),,pressn,]) * c(exp(-Freg[aa-1,] -m_at_age(rep)[aa-1]))
}
simN[16,as.character(yy),,ssn,] <- simN[16,as.character(yy),,ssn,] +
c(diff_coffs_age_period(par)[,,16,pressn] %*% c(simN[16,as.character(yy),,pressn,]) * c(exp(-Freg[16,] -m_at_age(rep)[16])))
}
}
xyplot(data~year|area, group=qname, data=FLQuants(qts(quantSums(sweep(simN, 1, waa(par), '*'))),
qts(quantSums(sweep(popN(rep), 1, waa(par), '*')))), type="l")
## calculate the fishery specific catches
simC <- FLQuant(NA, dimnames=list(age=seq(1, 16),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
for(aa in 2:16){
for(ff in 1:31){
rr <- region_fish_map[region_fish_map$fishery==ff, 'region']
simC[aa,'1972',ff,1,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa-1,'1972',,1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
for(qq in 2:4)
simC[aa,'1972',ff,qq,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa-1,'1972',,qq-1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
}
}
## calculate the fishery specific catches
simC <- FLQuant(NA, dimnames=list(age=seq(1, 16),
year=seq(range(frq)['minyear'],  range(frq)['maxyear']), unit=1:n_fisheries(frq), season=1:4, area='unique'))
for(aa in 1:16){
for(ff in 1:31){
rr <- region_fish_map[region_fish_map$fishery==ff, 'region']
simC[aa,'1972',ff,1,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa,'1972',,1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
for(qq in 2:4)
simC[aa,'1972',ff,qq,,] <- Ffa[aa,,ff,,]/(Ffa[aa,,ff,,]+m_at_age(rep)[aa]) * simN[aa,'1972',,qq-1,rr] * (1-exp(-Ffa[aa,,ff,,] -m_at_age(rep)[aa]))
}
}
simC
simN
?FLPar
?MFCLBiol
?MFCLPar
?`generate,MFCLFrq,MFCLprojControl,ANY-method`
?detach
.packages()
library(FLR4MFCL)
vignette()
vignette('xfun')
vignette('FLR4MFCL')
edit(vignette('xfun'))
edit(vignette('xfun'))
library(FLR4MFCL)
vignette(package='FLR4MFCL')
vignette('Introduction to FLR4MFCL')
vignette('Introduction_to_FLR4MFCL')
library(FLR4MFCL)
vignette('FLR4MFCL')
vignette()
getwd()
setwd('/home/rob/FLR4MFCL/ofp-sam-flr4mfcl/vignettes/')
devtools::build_vignettes()
data('frq')
data('frq.Rdata')
data(frq)
data()
data(package='FLCore')
data(package='FLR4MFCL')
load('frq')
load('frq.Rdata')
data(frq)
ls()
data(par)
data('par')
getwd()
cd ../..
devtools::build_vignettes()
